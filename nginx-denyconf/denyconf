#!/bin/bash

# ---------------------Проверка параметров-----------------------
if [[ $1 = "" ]] #Проверяем указан ли первый параметр(IP).
then
        echo Не указан 1 параметр. Проверьте корректность ввода. #Если параметр не указан...
        exit #Выходим из скрипта.
fi

if [[ $2 = "" ]] #Проверяем указан ли второй параметр(тип атаки).
then
        echo Не указан 2 параметр. Проверьте корректность ввода. #Если параметр не указан...
        exit #Выходим из скрипта.
fi

if [[ $3 = "" ]] #Проверяем указан ли третий параметр(адрес сайта).
then
        echo Не указан 3 параметр. Проверьте корректность ввода. #Если параметр не указан...
        exit #Выходим из скрипта.
fi

if [[ $4 = "" ]] #Проверяем указан ли четвертый параметр(дата).
then
        echo Не указан 4 параметр. Указываю текущую дату. #Если параметр не указан...
        DATE=`date '+%d.%m.%Y %H:%M:%S'` #Указываем текущую дату.
else
        DATE=$4 #Если параметр указан, присваеваем значение переменной.
fi

# ----------------------Проверка ключа типа атаки-----------------
var=$2 #Изначально присваеваем переменной значение указаного параметра. Это необходим в том, случае если указываеться отличный от нижеописанных ключ.
if [[ $2 = "b" ]] #Если второй параметр равен b...
then
        var="brutforce" #Присваиваем значение переменной.
fi

if [[ $2 = "d" ]] #Если второй параметр равен d...
then
        var="ddos" #Присваиваем значение переменной.
fi

if [[ $2 = "p" ]] #Если второй параметр равен p...
then
        var="proxy" #Присваиваем значение переменной.
fi

if [[ $2 = "s" ]] #Если второй параметр равен s...
then
        var="scan admin panel" #Присваиваем значение переменной.
fi

SIZE=`stat /etc/nginx/deny.conf | grep -o 'Size:\s[0-9]*' | awk '{print $2}'` #Вычисляем размер файла. Необходимо в том случае если deny.conf пустой.

if [[ $SIZE = "0" ]] #И если файл пустой...
then
        echo "allow all;" > /etc/nginx/deny.conf #Добавляем в него строку.
fi

STRING="deny "$1"; #"$var" "$3" "$DATE #Формируем строку для вывода в deny.conf.
sed -i -e "1 s/^/$STRING\n/;" /etc/nginx/deny.conf #Выводим строку первой в файле.

service nginx configtest #Делаем тест конфигов nginx...
if [[ $? = "1" ]] #И если будет найдена ошибка...
then
        echo Проверка конфигфайла прошла с ошибками. Проверьте конфиг вручную. nginx не был перезагружен. #Выводим сообщение об этом.
else
        service nginx reload #Перезапускаем nginx в случае если конфигтест прошёл успешно.
fi
